name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Dependency Check
  dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify package.json
        run: npm ls --depth=0

  # Job 2: Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [dependencies]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check Node.js syntax
        run: node -c server.js
      
      - name: Verify critical files
        run: |
          test -f package.json && echo "‚úì package.json exists"
          test -f server.js && echo "‚úì server.js exists"
          test -f public/index.html && echo "‚úì public/index.html exists"
      
      - name: Verify build
        run: |
          echo "Build verification passed"
          echo "‚úì All dependencies installed"
          echo "‚úì Application structure valid"
          echo "‚úì Ready for deployment"

  # Job 3: Deployment to Railway
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Railway
        uses: railwayapp/deploy-action@v1
        with:
          token: ${{ secrets.RAILWAY_TOKEN }}
          service: parking-payment-bc
          
      - name: Deployment Status
        run: |npm build
          echo "‚úÖ Deployment to Railway completed"
          echo "üöÄ Application is live at: https://web-production-98a85.up.railway.app"

  # Job 4: Notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Check deployment status
        run: |mpm deploy
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Pipeline completed successfully!"
            echo "üéâ Your application has been deployed to production"
          else
            echo "‚ö†Ô∏è Pipeline completed with warnings or errors"
          fi
